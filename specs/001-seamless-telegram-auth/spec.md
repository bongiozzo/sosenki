# Feature Specification: Плавная аутентификация через Telegram (seamless-telegram-auth)

**Feature Branch**: `001-seamless-telegram-auth`  
**Created**: 2025-11-03  
**Status**: Draft  
**Input**: User description:

> Любой пользователь Telegram может начать взаимодействовать с ботом (sosenkibot)
>
> - Пользователь может найти sosenkibot самостоятельно в поиске контактов Телеграм (не требует реализации)
> - Пользователь может переслать сообщение от sosenkibot другу в личном сообщении (не требует реализации)
> - Пользователь может начать взаимодействовать с sosenkibot, находясь в одной группе, куда бот был предварительно добавлен
>
> Для начала нам нужно реализовать самые базовые истории:
>
> - Выдача приветственного сообщения от sosenkibot с кнопкой открытия Mini App
> - При попытке открытия MiniApp происходит Аутентификация пользователя SOSenki - существует ли пользователь с таким Telegram id в SOSenki?
> - Если Пользователя пока нет, sosenkibot предлагает сформулировать Сообщение - например, Хотел бы арендовать дом (по умолчанию), Я хозяин дома 13 и т.д. для Запроса на подключение к системе;
> - В настройках SOSenki определён идентификатор Telegram ID первого Администратора (создателя бота);
> - В настройках SOSenki определён идентификатор чата Telegram Администраторской группы (Admin Group Chat), который по умолчанию равен Telegram ID первого Администратора;
> - sosenkibot отправляет Запрос от пользователя в Admin Group Chat с текстом Сообщения и кнопками Добавить / Отклонить
> - Ответом на сообщение боту Администратор может добавить его в систему или отклонить запрос
> - При добавлении Администратор сразу назначает Пользователю одну из Ролей (Administrator, Tenant, Owner, Investor)
> - Пользователь получает уведомление от бота об отказе или приветствует пользователя в системе
> - При открытии первой страницы Mini App Пользователь SOSenki видит Приветственный текст

## Clarifications

### Session 2025-11-03

- Q1: Как создавать пользователя при обработке запроса администратором? → A: Option A — при подтверждении администратором создаётся новый пользователь SOSenki и в поле `telegram_id` записывается Telegram ID из запроса. (MVP: самый простой путь.)
- Q2: Идентификатор Telegram — это первичный ключ для связи? → A: Да — `telegram_id` считается уникальным идентификатором (PK/unique) для привязки пользователя к Telegram в контексте этого потока.
- Q3: При конфликте `telegram_id` (уже есть пользователь с таким telegram_id) — как поступать? → A: Выдать ошибку повторного добавления; создание пользователя должно быть отклонено и администратор увидит сообщение об ошибке `user_already_exists`.
- Q4: Появляется ли форма запроса, если пользователь уже добавлен? → A: Нет — запрос на присоединение к системе появляется ТОЛЬКО если у Telegram-пользователя нет доступа / не связан с записью SOSenki. Если пользователь уже добавлен (есть `telegram_id`), форма запроса не показывается.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Открытие Mini App и быстрая проверка пользователя (Priority: P1)

Кратко: Пользователь нажимает кнопку в приветственном сообщении бота и пытается открыть Mini App. Система должна проверить, есть ли Telegram ID этого пользователя в базе SOSenki и либо сразу открыть приветственную страницу, либо предложить создать запрос на подключение.

Why this priority: это основной путь — позволяет пользователю впервые попасть в Mini App и определяет дальнейший поток взаимодействия.

Independent Test: отправить тестовое приветственное сообщение боту, нажать кнопку «Открыть Mini App» и проверить поведение в случае существующего/несуществующего пользователя.

Acceptance Scenarios:

1. Given: Telegram-пользователь получил приветственное сообщение от sosenkibot; When: нажимает кнопку открытия Mini App; Then: если Telegram ID связан с пользователем в системе — открывается первая страница Mini App с приветственным текстом и доступом к своему профилю.
2. Given: Telegram-пользователь нажал кнопку открытия Mini App; When: Telegram ID не найден в системе; Then: внутри Mini App пользователь видит интерфейс для формирования запроса на подключение (короткое текстовое сообщение) и кнопку «Отправить запрос».

---

### User Story 2 - Отправка запроса на подключение (Priority: P2)

Кратко: Если пользователя нет в системе, бот/mini app предлагает сформулировать короткое сообщение-запрос. После подтверждения запрос передаётся администраторам SOSenki.

Why this priority: без этого шага пользователь не сможет быть добавлен.

Independent Test: из аккаунта без соответствия в системе попытаться отправить запрос и убедиться, что администратор получает сообщение от бота с содержимым запроса и идентификатором Telegram.

Acceptance Scenarios:

1. Given: пользователь без учётной записи формирует сообщение; When: нажимает «Отправить запрос»; Then: бот подтверждает отправку и показывает сообщение «Ваш запрос отправлен администраторам». Администратор получает сообщение через Telegram с текстом запроса и кнопками «Добавить» / «Отклонить».

---

### User Story 3 - Обработка запроса администратором (Priority: P3)

Кратко: Администратор видит входящее сообщение от бота и может принять или отклонить запрос; при принятии администратор выбирает роль пользователя.

Why this priority: обеспечивает контроль доступа и назначение ролей — необходим для корректной работы системы.

Independent Test: отправить запрос от тестового Telegram-идентификатора, выбрать роль и подтвердить от имени одного из Администраторов — затем проверить, что пользователь получил уведомление о добавлении и назначенной роли.

Acceptance Scenarios:

1. Given: администратор получил запрос; When: администратор выбирает «Добавить» и выбирает роль (Administrator, Tenant, Owner, Investor); Then: система проверяет Администратора и создаёт пользователя с указанной ролью, бот отправляет пользователю приветственное сообщение с указанием роли.
2. Given: администратор выбирает «Отклонить»; When: подтверждает отклонение; Then: бот отправляет пользователю сообщение об отказе и причина (если указана) и помечает запрос как отклонённый.

---

### Edge Cases

- Пользователь отправил несколько одинаковых запросов подряд — система должна дедуплицировать запросы от одного Telegram ID и сообщать пользователю о том, что запрос уже отправлен.
- В чате администратора несколько администраторов нажали «Добавить» одновременно — только первый подтверждённый ответ должен создать пользователя; остальные — получат уведомление, что запрос уже обработан.
- Администратор не назначил роль — интерфейс не должен позволять завершить добавление без выбора одной из ролей.
- Пользователь указал недопустимый или оскорбительный текст в запросе — запрос принимается, но админам рекомендуется иметь возможность отклонить и указать причину.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Бот `sosenkibot` MUST отправлять приветственное сообщение с кнопкой «Открыть Mini App» для пользователей, которые взаимодействуют с ботом в личном чате или в группе, где бот присутствует.
- **FR-002**: При попытке открыть Mini App система MUST проверить наличие Telegram ID в базе SOSenki и вернуть результат проверки (существует / не существует).
- **FR-003**: Если Telegram ID не найден, пользователь MUST иметь возможность сформировать короткое текстовое сообщение-запрос (не более 280 символов) и отправить его администраторам через бота.
- **FR-004**: Бот MUST отправлять сообщение в Admin Group Chat с текстом запроса, идентификатором Telegram пользователя, ссылкой на его профиль и интерактивными действиями: «Добавить» и «Отклонить».
- **FR-005**: При выборе «Добавить» администратор MUST выбирать одну из предопределённых ролей: Administrator, Tenant, Owner, Investor. После подтверждения пользователь MUST быть создан в системе с указанной ролью.
- **FR-006**: При выборе «Отклонить» администратор MUST иметь возможность указать причину (необязательно); бот MUST уведомить пользователя об отказе.
- **FR-007**: После успешного добавления бот MUST отправить пользователю приветственное сообщение внутри Telegram с краткой информацией о роли и ссылкой/кнопкой для открытия Mini App.
- **FR-008**: Все сообщения от бота, связанные с созданием/отклонением запросов, MUST содержать уникальный идентификатор запроса для дальнейшего аудита.
- **FR-009**: Система MUST предотвращать дублирование запросов от одного Telegram ID.
- **FR-010**: Значение `telegram_id` MUST быть уникальным в модели `SOSenkiUser` и использоваться как первичный способ связи между Telegram-аккаунтом и пользовательской записью (при добавлении пользователя администратором `telegram_id` записывается в поле и помечается как уникальное). При попытке создать пользователя с `telegram_id`, который уже существует в SOSenki для другого пользователя, операция создания MUST быть отклонена с ошибкой `user_already_exists` и записью события в аудите.
- **FR-011**: Запрос на присоединение (форма) MUST отображаться пользователю ТОЛЬКО если Telegram ID не связан с существующим `SOSenkiUser` (у пользователя нет доступа). Если `telegram_id` уже связан — форма запроса не показывается и пользователь видит сообщение о том, что у него уже есть доступ.

### Key Entities *(include if feature involves data)*

- **TelegramUserCandidate**: временный объект запроса — содержит Telegram ID, текст запроса, timestamp, статус (pending/accepted/rejected), request_id.
- **AdminAction**: запись действия администратора — кто обработал запрос, время, выбранная роль или причина отклонения.
- **SOSenkiUser**: существующий пользователь в системе — имеет связь с Telegram ID после добавления и поле role (Administrator, Tenant, Owner, Investor).

- **Notes on SOSenkiUser telegram_id**: `telegram_id` is a unique identifier for linking Telegram accounts. For the MVP flow, when an admin accepts a request the system will create a new `SOSenkiUser` record and set `telegram_id` to the provided Telegram ID. Implementations MUST enforce uniqueness (unique constraint). If a create is attempted with a `telegram_id` that already exists for a different user, the service MUST reject the operation and return a clear error (`user_already_exists`) to the admin; an `AdminAction` audit entry MUST be created recording the attempted duplicate.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% случаев открытия Mini App от пользователя с существующим Telegram ID сразу отображают приветственную страницу (функциональная корректность).
- **SC-002**: 95% отправленных пользователем запросов доставляются администраторам и помечаются как «в обработке» в течение 30 секунд.
- **SC-003**: 90% запросов получают ответ (принят/отклонён) от администратора в течение 24 часов.
- **SC-004**: Дублированные запросы от одного Telegram ID в 100% случаев.
- **SC-005**: Пользователи, добавленные администратором, получают уведомление о добавлении в 100% случаев и могут открыть Mini App и увидеть приветственный текст.

---

### Assumptions

- Администраторы SOSenki имеют отдельный (существующий) админ-чат/способ получения сообщений от бота.
- Минимально жизнеспособная версия не включает автоматическое подтверждение запроса без участия администратора.
- Максимальная длина сообщения-запроса — 280 символов (разумное ограничение для коротких заявок).

### Notes

- Спецификация фокусируется на пользовательских сценариях и требованиях; детали реализации (протоколы, API, хранилище) намеренно опущены и будут определены в планировании/техническом задании.
